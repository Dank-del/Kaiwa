{% extends "chat/base.html" %} {% block main_content %}
<div class="chat-container">
  <div id="chat-box">
    <!-- Messages will be displayed here -->
  </div>
  <div class="message-input">
    <div class="chat-msg-input field border round fill small">
      <input
        type="text"
        id="chat-message-input"
        placeholder="Type a message..."
      />
    </div>
    <button class="fill" id="chat-message-submit" onclick="sendMessage()">Send</button>
  </div>
</div>

<script>
  const roomName = "{{ room_name }}"; // Passed from Django view
  const chatSocket = new WebSocket(
    "ws://" + window.location.host + "/ws/chat/" + roomName + "/"
  );

  chatSocket.onmessage = function (e) {
    const data = JSON.parse(e.data);
    displayMessage(data.message, data.sender.id, data.sender.username);
  };

  chatSocket.onclose = function (e) {
    console.error("Chat socket closed unexpectedly");
  };

  function sendMessage() {
    const messageInput = document.getElementById("chat-message-input");
    const message = messageInput.value;
    chatSocket.send(JSON.stringify({ message: message }));
    messageInput.value = "";
  }

  function displayMessage(message, senderId, senderUsername) {
    const messageElement = document.createElement("div");
    messageElement.className =
      "message primary" +
      (senderId === "{{ user.id }}" ? " my-message" : " other-message");
    messageElement.innerText = senderUsername + ": " + message;
    document.querySelector("#chat-box").appendChild(messageElement);
    messageElement.scrollIntoView({ behavior: "smooth" });
  }

  document.querySelector("#chat-message-input").focus();
  document.querySelector("#chat-message-input").onkeyup = function (e) {
    if (e.keyCode === 13) {
      // enter, return
      sendMessage();
    }
  };
</script>

<style>
  .chat-container {
    display: flex;
    flex-direction: column;
    height: 100vh; /* Full height of the viewport */
    width: 100%;
  }

  #chat-box {
    flex-grow: 1;
    overflow-y: auto;
    padding: 10px;
    margin-bottom: 10px;
  }

  .message-input {
    display: flex;
    padding: 10px;
    bottom: 10%;
    position: relative;
  }

  .chat-msg-input {
    flex-grow: 1;
  }

  .message {
    padding: 5px 10px;
    border-radius: 5px;
    margin-bottom: 5px;
    word-break: break-word;
  }

  .my-message {
    background-color: #dcf8c6;
    align-self: flex-end;
  }

  .other-message {
    background-color: #e5e5ea;
    align-self: flex-start;
  }
</style>
{% endblock %}
